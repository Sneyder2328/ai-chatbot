---
description: Prisma schema conventions - UUIDv7 IDs, timestamptz, snake_case mapping
globs: packages/db/prisma/**/*
---

# Prisma Schema Conventions

When creating or modifying Prisma models, follow these conventions for consistency and best practices.

## ID Fields

Use UUIDv7 for all primary keys (except the ones with ids autogenerated by better-auth as user, account, verification and session tables):

```prisma
id String @id @default(uuid(7)) @db.Uuid
```

## Timestamp Fields

Use PostgreSQL's `timestamptz` type for all timestamp fields:

```prisma
createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz
```

**Why timestamptz?**
- Stores timezone information
- Automatically handles timezone conversions
- Industry standard for timestamp storage in PostgreSQL

### Common Timestamp Patterns

**Required timestamps (most models should have these):**

```prisma
createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz
```

**Expiration timestamps:**

```prisma
expiresAt DateTime @map("expires_at") @db.Timestamptz
```

**Optional timestamps:**

```prisma
deletedAt DateTime? @map("deleted_at") @db.Timestamptz
```

## Naming Conventions & Mapping

### Table Names

- Use `@@map()` to map PascalCase model names to snake_case table names
- Table names should be plural

```prisma
model User {
  // fields...
  @@map("users")
}

model ChatMessage {
  // fields...
  @@map("chat_messages")
}
```

### Column Names

- Use `@map()` to map camelCase field names to snake_case column names
- Only needed when the column name differs from the field name

```prisma
model User {
  id            Uuid     @id @default(uuid(7))
  email         String   @unique
  emailVerified Boolean  @default(false) @map("email_verified")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
  
  @@map("users")
}
```

### Foreign Keys

- Use camelCase in Prisma (e.g., `userId`)
- Map to snake_case in database (e.g., `user_id`)

```prisma
userId String @map("user_id")
```

## Complete Model Example

```prisma
model ChatMessage {
  id        Uuid     @id @default(uuid(7))
  chatId    String   @map("chat_id")
  userId    String   @map("user_id")
  content   String
  role      String
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  chat      Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([chatId])
  @@index([userId])
  @@map("chat_messages")
}
```

## Checklist for New Models

When creating a new model, verify:

- [ ] `id` field uses `Uuid @id @default(uuid(7))`
- [ ] `createdAt` field uses `@default(now()) @map("created_at") @db.Timestamptz`
- [ ] `updatedAt` field uses `@updatedAt @map("updated_at") @db.Timestamptz`
- [ ] Model has `@@map("snake_case_plural_name")`
- [ ] All multi-word fields have `@map("snake_case_name")`
- [ ] Foreign key fields have appropriate `@map()` annotations
- [ ] Indexes are added for foreign keys and frequently queried fields

## Anti-patterns to Avoid

❌ **Don't use auto-increment IDs:**
```prisma
id Int @id @default(autoincrement())  // Avoid
```

❌ **Don't use regular UUID (v4):**
```prisma
id String @id @default(uuid())  // Avoid - not time-sortable
```

❌ **Don't use DateTime without timestamptz:**
```prisma
createdAt DateTime @default(now())  // Missing @db.Timestamptz
```

❌ **Don't skip snake_case mapping:**
```prisma
model UserProfile {
  userId String  // Missing @map("user_id")
  // Missing @@map("user_profiles")
}
```
